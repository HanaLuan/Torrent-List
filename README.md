# Torrent-list

感谢你找到了这个小项目😊（嘿嘿）

这是一个基于 Express.js + PostgreSQL 的磁力种子存储站，已完成从 JSON 本地存储到数据库存储的迁移，数据持久化和稳定性更优。

## 特别鸣谢

特别感谢 [yang杨](https://github.com/yang1145) 对本项目前端界面的精心优化！您的贡献使界面更加美观、直观和易用。

## 官方网站: [来看看吧~](https://wap-ac.ybmq.dpdns.org/)
注：亲爱的四川移动，河北移动，重庆移动网友，你们本地的运营商似乎屏蔽了我的域名😡😡😡

## 功能特性

### 用户系统
- **用户注册与登录**：支持新用户注册和现有用户登录
- **权限管理**：
  - 普通用户：可上传、查看和删除自己上传的文件
  - 管理员：可管理所有用户文件
- **默认管理员账号**：`admin/Zako114514`（首次启动服务器时，自动在数据库中创建）

### 文件管理
- **文件上传**：
  - 登录用户可上传 `.torrent` 文件（最大50MB）
  - 自动解析种子元数据（InfoHash、文件列表、Tracker 等）
- **文件浏览**：
  - 按上传时间倒序展示文件列表（含原始文件名、上传者、上传时间）
  - 实时搜索功能（按文件名或上传者筛选）
- **文件详情**：
  - 展示种子完整元数据（名称、InfoHash、总大小、文件列表、Tracker服务器等）
- **文件操作**：
  - 下载文件：默认使用原始文件名（含中文、特殊字符兼容）
  - 删除文件：普通用户仅删自己的文件，管理员可删所有文件（同时删除数据库记录和本地文件）

### 安全与稳定性
- **密码加密**：使用 bcrypt 哈希存储密码，不明文保存
- **会话管理**：基于 Cookie 的登录认证（有效期24小时）
- **数据持久化**：采用 PostgreSQL 数据库存储用户和文件数据，避免 JSON 文件损坏风险
- **输入校验**：文件类型、大小、用户权限全链路校验

## 技术栈

### 后端
- **核心框架**：Express.js
- **数据库**：PostgreSQL（数据存储）
- **数据库客户端**：`pg`（Node.js 连接 PostgreSQL）
- **环境配置**：`dotenv`（加载数据库连接等环境变量）
- **文件上传**：`multer`（处理文件上传逻辑）
- **密码加密**：`bcryptjs`（用户密码哈希）
- **种子解析**：`parse-torrent`（解析 .torrent 文件元数据）
- **数据格式化**：`pretty-bytes`（文件大小单位转换，如 B→MB）
- **请求处理**：`body-parser`（解析表单/JSON 请求）、`cookie-parser`（解析 Cookie）

### 前端
- **响应式设计**：适配桌面端、移动端
- **界面布局**：卡片式列表、详情页分层展示
- **交互体验**：上传进度条、操作结果即时反馈、中文/特殊字符文件名兼容

## 安装与运行

### 步骤1：克隆仓库
```bash
git clone
cd Torrent-list
```

### 步骤2：安装依赖
```bash
npm install
```

### 步骤3：配置环境变量（关键）
在项目根目录创建 `.env` 文件，填写 PostgreSQL 数据库连接信息（示例如下）：
```env
# .env 文件内容
DB_USER=postgres        # 数据库用户名（默认通常为 postgres）
DB_HOST=localhost       # 数据库地址（本地开发填 localhost）
DB_NAME=torrent_db      # 数据库名（需与后续创建的一致）
DB_PASSWORD=你的数据库密码  # 安装 PostgreSQL 时设置的密码
DB_PORT=5432            # 数据库端口（默认 5432，未修改则保持默认）
```

### 步骤4：创建 PostgreSQL 数据库
1. 打开 PostgreSQL 或数据库管理工具（如 Navicat），登录数据库。
2. 创建数据库：
   - 数据库名：`torrent_db`（需与 `.env` 中的 `DB_NAME` 一致）
   - 模板：`template0`（避免排序规则冲突）
   - 编码：`UTF8`

### 步骤5：启动服务器
```bash
node server.js
```
- 启动成功后，终端会显示：
  ```
  [dotenv@17.2.3] injecting env (5) from .env -- tip: 🔑 add access controls to secrets: https://dotenvx.com/ops
  服务器已启动: http://localhost:3000
  默认管理员创建成功
  数据库初始化完成
  ```
- 服务器默认运行在 `http://localhost:3000`


## 数据库结构
服务器启动时会 **自动创建两张核心表**（无需手动创建）：

### 1. `users` 表（用户表）
| 字段名   | 类型         | 说明                          | 约束                  |
|----------|--------------|-------------------------------|-----------------------|
| username | VARCHAR(50)  | 用户名（登录账号）            | 主键（唯一）、非空    |
| password | VARCHAR(100) | 加密后的密码（bcrypt 哈希）   | 非空                  |
| role     | VARCHAR(20)  | 用户角色（`user`/`admin`）    | 非空、默认 `user`     |

### 2. `files` 表（文件表）
| 字段名         | 类型         | 说明                          | 约束                  |
|----------------|--------------|-------------------------------|-----------------------|
| saved_name     | VARCHAR(255) | 服务器存储的文件名（唯一）    | 主键（唯一）、非空    |
| original_name  | VARCHAR(255) | 用户上传的原始文件名          | 非空                  |
| uploader       | VARCHAR(50)  | 上传者用户名                  | 非空、外键关联 `users.username` |
| upload_time    | TIMESTAMP（6）    | 上传时间                      | 非空                  |
| torrent_meta   | JSONB        | 种子元数据（解析后的结构化信息）| 可空（解析失败时为错误信息） |

## 使用说明

### 1. 首次使用
- 登录默认管理员账号：`admin` / 密码 `Zako114514`（建议登录后修改密码）
- 普通用户可通过“注册”功能创建账号（默认角色为 `user`）

### 2. 核心操作流程
1. **登录/注册**：进入首页，点击右上角“登录”或“注册”。
2. **上传文件**：登录后，选择 `.torrent` 文件，点击“上传”（支持中文/特殊字符文件名）。
3. **浏览文件**：首页展示所有文件，可通过搜索框筛选文件。
4. **查看详情**：点击文件名进入详情页，查看种子元数据。
5. **下载/删除**：详情页或首页可点击“下载”（获取原始文件名）或“删除”（需对应权限）。


## 注意事项

1. **数据库备份**：
   - 定期通过 PostgreSQL 工具或 Navicat 备份 `torrent_db` 数据库，避免数据丢失。
   - 备份命令示例（终端）：`pg_dump -U postgres torrent_db > backup.sql`

2. **文件存储**：
   - 上传的 `.torrent` 文件实际保存在项目根目录的 `uploads` 文件夹，删除文件时会自动删除该目录下的对应文件。
   - 若手动删除 `uploads` 中的文件，下次启动服务器时，文件列表会自动过滤掉本地已不存在的记录。

3. **安全优化（生产环境）**：
   - 修改默认管理员密码：登录后通过数据库直接更新 `users` 表的 `password` 字段（需 bcrypt 加密）。
   - 启用 HTTPS：通过 Nginx 配置或 Express 插件（如 `helmet`）启用 HTTPS。
   - 限制上传频率：添加接口限流（如 `express-rate-limit`），防止恶意上传。

4. **兼容性**：
   - 下载文件名支持中文、空格、`[`/`]` 等特殊字符，无需额外处理。


## 未来计划
- [ ] 新增用户资料管理：支持修改密码、个人信息
- [ ] 新增文件分类/标签功能：支持按标签筛选文件
- [ ] 优化前端体验：添加文件预览、上传历史记录
- [ ] 生产环境优化：添加日志切割、性能监控


## 许可证

本项目采用 **MIT LICENSE** 开源，可自由修改、分发和商用。
