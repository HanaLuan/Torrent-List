# Torrent-list

[English](./Docs/readme_en.md) | [中文](./README.md)| [繁体中文](./Docs/readme_tcn.md)  

感谢你找到了这个小项目😊（嘿嘿）

这是一个基于 Express.js + PostgreSQL 的磁力种子存储站

## 特别鸣谢

特别感谢 [yang杨](https://github.com/yang1145) 对本项目前端部分界面的精心优化！您的贡献使界面更加美观易用。

## 官方网站（因为一些原因暂缓更新新版本）: [过段时间再来看看吧~](https://wap-ac.ybmq.dpdns.org/)

## 功能特性

### 用户系统
- **用户注册与登录**：支持新用户注册和现有用户登录
- **权限管理**：
  - 普通用户：可上传、查看和删除自己上传的文件
  - 管理员：可管理所有用户文件、管理用户账号（增删改查）
- **默认管理员账号**：`admin/Zako114514`（首次启动服务器时，自动在数据库中创建）
- **管理员面板**：专属管理界面，提供系统概览和用户管理“增删改查”功能

### 文件管理
- **文件上传**：
  - 登录用户可上传 `.torrent` 文件（最大50MB）
  - 自动解析种子元数据（InfoHash、文件列表、Tracker 等）
- **文件浏览**：
  - 按上传时间倒序展示文件列表（含原始文件名、上传者、上传时间）
  - 实时搜索功能（按文件名或上传者筛选）
- **文件详情**：
  - 展示种子完整元数据（名称、InfoHash、总大小、文件列表、Tracker服务器等）
- **文件操作**：
  - 下载文件：默认使用原始文件名（含中文、特殊字符兼容）
  - 删除文件：普通用户仅删自己的文件，管理员可删所有文件（同时删除数据库记录和本地文件）

### 安全与稳定性
- **密码加密**：使用 bcrypt 哈希存储密码，不明文保存
- **会话管理**：基于 Cookie 的登录认证（有效期24小时）
- **数据持久化**：采用 PostgreSQL 数据库存储用户和文件数据
- **输入校验**：文件类型、大小、用户权限全链路校验
- **权限控制**：管理员操作需特殊权限验证，禁止删除管理员账号和角色降级

## 技术栈

### 后端
- **核心框架**：Express.js
- **数据库**：PostgreSQL（数据存储）
- **数据库客户端**：`pg`（Node.js 连接 PostgreSQL）
- **环境配置**：`dotenv`（加载数据库连接等环境变量）
- **文件上传**：`multer`（处理文件上传逻辑）
- **密码加密**：`bcryptjs`（用户密码哈希）
- **种子解析**：`parse-torrent`（解析 .torrent 文件元数据）
- **数据格式化**：`pretty-bytes`（文件大小单位转换，如 B→MB）
- **请求处理**：`body-parser`（解析表单/JSON 请求）、`cookie-parser`（解析 Cookie）

### 前端
- **响应式设计**：适配桌面端、移动端
- **精美的界面布局**：卡片式列表、详情页分层展示、管理员专属面板
- **舒适的交互体验**：上传进度条、操作结果即时反馈、中文/特殊字符文件名兼容、用户管理表单

## 安装与运行

### 步骤1：克隆仓库
```bash
git clone https://github.com/HanaLuan/Torrent-List.git
cd Torrent-list
```

### 步骤2：安装依赖
```bash
npm install
```

### 步骤3：配置环境变量（关键）
在项目根目录创建 `.env` 文件，填写 PostgreSQL 数据库连接信息（示例如下）：
```env
# .env 文件内容
DB_USER=postgres        # 数据库用户名（默认通常为 postgres）
DB_HOST=localhost       # 数据库地址（本地开发填 localhost）
DB_NAME=torrent_db      # 数据库名（需与后续创建的一致）
DB_PASSWORD=你的数据库密码  # 安装 PostgreSQL 时设置的密码
DB_PORT=5432            # 数据库端口（默认 5432，未修改则保持默认）
```

### 步骤4：创建并初始化数据库
1. 打开 PostgreSQL 或数据库管理工具（如 Navicat），登录数据库，创建数据库：
   - 数据库名：`torrent_db`（需与 `.env` 中的 `DB_NAME` 一致）
   - 模板：`template0`（避免排序规则冲突）
   - 编码：`UTF8`

2. 初始化数据库（创建表结构和默认管理员）：
   ```bash
   npm run db:init
   ```
   - 成功后终端会显示“数据库初始化全部完成！”，并自动创建 `users` 和 `files` 表，以及默认管理员账号。


### 步骤5：启动服务器
```bash
npm start
```
- 启动成功后，终端会显示：
  ```
  服务器已启动: http://localhost:3000
  ```
- 服务器默认运行在 `http://localhost:3000`


## 数据库结构
数据库初始化脚本（`npm run db:init`）会自动创建以下两张核心表：

### 1. `users` 表（用户表）
| 字段名   | 类型         | 说明                          | 约束                  |
|----------|--------------|-------------------------------|-----------------------|
| username | VARCHAR(50)  | 用户名（登录账号）            | 主键（唯一）、非空    |
| password | VARCHAR(100) | 加密后的密码（bcrypt 哈希）   | 非空                  |
| role     | VARCHAR(20)  | 用户角色（`user`/`admin`）    | 非空、默认 `user`     |

### 2. `files` 表（文件表）
| 字段名         | 类型         | 说明                          | 约束                  |
|----------------|--------------|-------------------------------|-----------------------|
| saved_name     | VARCHAR(255) | 服务器存储的文件名（唯一）    | 主键（唯一）、非空    |
| original_name  | VARCHAR(255) | 用户上传的原始文件名          | 非空                  |
| uploader       | VARCHAR(50)  | 上传者用户名                  | 非空、外键关联 `users.username` |
| upload_time    | TIMESTAMP（6）| 上传时间                      | 非空                  |
| torrent_meta   | JSONB        | 种子元数据（解析后的结构化信息）| 可空（解析失败时为错误信息） |

## 使用说明

### 1. 首次使用
- 登录默认管理员账号：`admin` / 密码 `Zako114514`（建议登录后立即修改密码）
- 普通用户可通过“注册”功能创建账号（默认角色为 `user`）

### 2. 核心操作流程
1. **登录/注册**：进入首页，点击右上角“登录”或“注册”。
2. **上传文件**：登录后，选择 `.torrent` 文件，点击“上传”（支持中文/特殊字符文件名）。
3. **浏览文件**：首页展示所有文件，可通过搜索框筛选文件。
4. **查看详情**：点击文件名进入详情页，查看种子元数据。
5. **下载/删除**：详情页或首页可点击“下载”（获取原始文件名）或“删除”（需对应权限）。

### 3. 管理员操作
1. **进入管理员面板**：登录管理员账号后，首页导航栏会显示“管理员面板”入口。
2. **系统概览**：查看用户总数、文件总数和文件总大小统计数据。
3. **用户管理**：
   - 查看所有用户列表，支持按用户名/角色搜索
   - 新增用户：指定用户名、密码和角色（`user`/`admin`）
   - 修改用户角色：在用户列表中编辑角色（禁止将管理员降级为普通用户）
   - 重置用户密码：直接设置新密码（无需知道旧密码）
   - 删除用户：会同时删除该用户上传的所有文件

## 注意事项

1. **数据库备份**：
   - 定期通过 PostgreSQL 工具或 Navicat 备份 `torrent_db` 数据库，避免数据丢失。
   - 备份命令示例（终端）：`pg_dump -U postgres torrent_db > backup.sql`

2. **文件存储**：
   - 上传的 `.torrent` 文件实际保存在项目根目录的 `uploads` 文件夹，删除文件时会自动删除该目录下的对应文件。
   - 若手动删除 `uploads` 中的文件，下次启动服务器时，文件列表会自动过滤掉本地已不存在的记录。

3. **安全优化（生产环境）**：
   - 修改默认管理员密码：登录后通过管理员界面修改密码，或数据库直接更新 `users` 表的 `password` 字段（需 bcrypt 加密）。
   - 启用 HTTPS：通过 Nginx 配置或 Express 插件（如 `helmet`）启用 HTTPS。
   - 限制上传频率：添加接口限流（如 `express-rate-limit`），防止恶意上传。

4. **兼容性**：
   - 下载文件名支持中文、空格、`[`/`]` 等特殊字符，无需额外处理。


## 未来计划
待定。。。。。。


## 许可证

本项目采用 **MIT LICENSE** 开源。
