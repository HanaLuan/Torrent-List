# Torrent-list

*本readme由豆包AI翻譯*

[English](./readme_en.md) | [中文](../README.md)| [繁體中文](./readme_tcn.md)  

感謝你找到了這個小項目😊（嘿嘿）

這是一個基於 Express.js + PostgreSQL 的磁力種子存儲站


## 特別鳴謝

特別感謝 [yang楊](https://github.com/yang1145) 對本項目前端部分界面的精心優化！您的貢獻使界面更加美觀易用。


## 官方網站（因一些原因暫緩更新新版本）: [過一段時間再來看看吧~](https://wap-ac.ybmq.dpdns.org/)


## 功能特性

### 用戶系統
- **用戶註冊與登錄**：支持新用戶註冊和現有用戶登錄
- **權限管理**：
  - 普通用戶：可上傳、查看和刪除自己上傳的文件
  - 管理員：可管理所有用戶文件、管理用戶賬號（增刪改查）
- **默認管理員賬號**：`admin/Zako114514`（首次啟動服務器時，自動在數據庫中創建）
- **管理員面板**：專屬管理界面，提供系統概覽和用戶管理「增刪改查」功能


### 文件管理
- **文件上傳**：
  - 登錄用戶可上傳 `.torrent` 文件（最大50MB）
  - 自動解析種子元數據（InfoHash、文件列表、Tracker 等）
- **文件瀏覽**：
  - 按上傳時間倒序展示文件列表（含原始文件名、上傳者、上傳時間）
  - 實時搜索功能（按文件名或上傳者篩選）
- **文件詳情**：
  - 展示種子完整元數據（名稱、InfoHash、總大小、文件列表、Tracker服務器等）
- **文件操作**：
  - 下載文件：默認使用原始文件名（含中文、特殊字符兼容）
  - 刪除文件：普通用戶僅刪自己的文件，管理員可刪所有文件（同時刪除數據庫記錄和本地文件）


### 安全與穩定性
- **密碼加密**：使用 bcrypt 哈希存儲密碼，不明文保存
- **會話管理**：基於 Cookie 的登錄認證（有效期24小時）
- **數據持久化**：採用 PostgreSQL 數據庫存儲用戶和文件數據
- **輸入校驗**：文件類型、大小、用戶權限全鏈路校驗
- **權限控制**：管理員操作需特殊權限驗證，禁止刪除管理員賬號和角色降級


## 技術棧

### 後端
- **核心框架**：Express.js
- **數據庫**：PostgreSQL（數據存儲）
- **數據庫客戶端**：`pg`（Node.js 連接 PostgreSQL）
- **環境配置**：`dotenv`（加載數據庫連接等環境變量）
- **文件上傳**：`multer`（處理文件上傳邏輯）
- **密碼加密**：`bcryptjs`（用戶密碼哈希）
- **種子解析**：`parse-torrent`（解析 .torrent 文件元數據）
- **數據格式化**：`pretty-bytes`（文件大小單位轉換，如 B→MB）
- **請求處理**：`body-parser`（解析表單/JSON 請求）、`cookie-parser`（解析 Cookie）


### 前端
- **響應式設計**：適配桌面端、移動端
- **精美的界面佈局**：卡片式列表、詳情頁分層展示、管理員專屬面板
- **舒適的交互體驗**：上傳進度條、操作結果即時反饋、中文/特殊字符文件名兼容、用戶管理表單


## 安裝與運行

### 步驟1：克隆倉庫
```bash
git clone https://github.com/HanaLuan/Torrent-List.git
cd Torrent-list
```

### 步驟2：安裝依賴
```bash
npm install
```

### 步驟3：配置環境變量（關鍵）
在項目根目錄建立 `.env` 檔案，填寫 PostgreSQL 數據庫連接信息（示例如下）：
```env
# .env 檔案內容
DB_USER=postgres        # 數據庫用戶名（默認通常為 postgres）
DB_HOST=localhost       # 數據庫地址（本地開發填 localhost）
DB_NAME=torrent_db      # 數據庫名（需與後續創建的一致）
DB_PASSWORD=你的數據庫密碼  # 安裝 PostgreSQL 時設置的密碼
DB_PORT=5432            # 數據庫端口（默認 5432，未修改則保持默認）
```

### 步驟4：創建並初始化數據庫
1. 打開 PostgreSQL 或數據庫管理工具（如 Navicat），登錄數據庫，創建數據庫：
   - 數據庫名：`torrent_db`（需與 `.env` 中的 `DB_NAME` 一致）
   - 模板：`template0`（避免排序規則衝突）
   - 編碼：`UTF8`

2. 初始化數據庫（創建表結構和默認管理員）：
   ```bash
   npm run db:init
   ```
   - 成功後終端會顯示「數據庫初始化全部完成！」，並自動創建 `users` 和 `files` 表，以及默認管理員賬號。


### 步驟5：啟動服務器
```bash
npm start
```
- 啟動成功後，終端會顯示：
  ```
  服務器已啟動: http://localhost:3000
  ```
- 服務器默認運行在 `http://localhost:3000`


## 數據庫結構
數據庫初始化腳本（`npm run db:init`）會自動創建以下兩張核心表：

### 1. `users` 表（用戶表）
| 欄位名   | 類型         | 說明                          | 約束                  |
|----------|--------------|-------------------------------|-----------------------|
| username | VARCHAR(50)  | 用戶名（登錄賬號）            | 主鍵（唯一）、非空    |
| password | VARCHAR(100) | 加密後的密碼（bcrypt 哈希）   | 非空                  |
| role     | VARCHAR(20)  | 用戶角色（`user`/`admin`）    | 非空、默認 `user`     |

### 2. `files` 表（文件表）
| 欄位名         | 類型         | 說明                          | 約束                  |
|----------------|--------------|-------------------------------|-----------------------|
| saved_name     | VARCHAR(255) | 服務器存儲的文件名（唯一）    | 主鍵（唯一）、非空    |
| original_name  | VARCHAR(255) | 用戶上傳的原始文件名          | 非空                  |
| uploader       | VARCHAR(50)  | 上傳者用戶名                  | 非空、外鍵關聯 `users.username` |
| upload_time    | TIMESTAMP（6）| 上傳時間                      | 非空                  |
| torrent_meta   | JSONB        | 種子元數據（解析後的結構化信息）| 可空（解析失敗時為錯誤信息） |


## 使用說明

### 1. 首次使用
- 登錄默認管理員賬號：`admin` / 密碼 `Zako114514`（建議登錄後立即修改密碼）
- 普通用戶可通過「註冊」功能創建賬號（默認角色為 `user`）


### 2. 核心操作流程
1. **登錄/註冊**：進入首頁，點擊右上角「登錄」或「註冊」。
2. **上傳文件**：登錄後，選擇 `.torrent` 文件，點擊「上傳」（支持中文/特殊字符文件名）。
3. **瀏覽文件**：首頁展示所有文件，可通過搜索框篩選文件。
4. **查看詳情**：點擊文件名進入詳情頁，查看種子元數據。
5. **下載/刪除**：詳情頁或首頁可點擊「下載」（獲取原始文件名）或「刪除」（需對應權限）。


### 3. 管理員操作
1. **進入管理員面板**：登錄管理員賬號後，首頁導航欄會顯示「管理員面板」入口。
2. **系統概覽**：查看用戶總數、文件總數和文件總大小統計數據。
3. **用戶管理**：
   - 查看所有用戶列表，支持按用戶名/角色搜索
   - 新增用戶：指定用戶名、密碼和角色（`user`/`admin`）
   - 修改用戶角色：在用戶列表中編輯角色（禁止將管理員降級為普通用戶）
   - 重置用戶密碼：直接設置新密碼（無需知道舊密碼）
   - 刪除用戶：會同時刪除該用戶上傳的所有文件


## 注意事項

1. **數據庫備份**：
   - 定期通過 PostgreSQL 工具或 Navicat 備份 `torrent_db` 數據庫，避免數據丟失。
   - 備份命令示例（終端）：`pg_dump -U postgres torrent_db > backup.sql`

2. **文件存儲**：
   - 上傳的 `.torrent` 文件實際保存在項目根目錄的 `uploads` 文件夾，刪除文件時會自動刪除該目錄下的對應文件。
   - 若手動刪除 `uploads` 中的文件，下次啟動服務器時，文件列表會自動過濾掉本地已不存在的記錄。

3. **安全優化（生產環境）**：
   - 修改默認管理員密碼：登錄後通過管理員界面修改密碼，或數據庫直接更新 `users` 表的 `password` 欄位（需 bcrypt 加密）。
   - 啟用 HTTPS：通過 Nginx 配置或 Express 插件（如 `helmet`）啟用 HTTPS。
   - 限制上傳頻率：添加接口限流（如 `express-rate-limit`），防止惡意上傳。

4. **兼容性**：
   - 下載文件名支持中文、空格、`[`/`]` 等特殊字符，無需額外處理。


## 未來計劃
待定。。。。。。


## 許可證

本項目採用 **MIT LICENSE** 開源。
